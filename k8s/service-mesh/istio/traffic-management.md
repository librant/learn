### 流量管理

#### 1、流量管理介绍

为了在网格中导流，Istio 需要知道所有的 endpoint 在哪和属于哪个服务；

#### 2、虚拟服务 Virtual Service

虚拟服务让您配置如何在服务网格内将请求路由到服务，这基于 Istio 和平台提供的基本的连通性和服务发现能力；

- 通过单个虚拟服务处理多个应用程序服务
- 和网关整合并配置流量规则来控制出入流量

1) 字段解析
- hosts：
  - 使用 hosts 字段列举虚拟服务的主机
  - 为没有路由到网格内部的虚拟主机建模

2) 路由规则
- 匹配条件
  - http/tcp: 包含了虚拟服务的路由规则
- Destination
  - route 部分的 destination 字段指定了符合此条件的流量的实际目标地址

3) 路由规则优先级
- 路由规则按从上到下的顺序选择，虚拟服务中定义的第一条规则有最高优先级

4) 路由规则的更多内容
- HTTPMatchRequest
- HTTPRoute

使用路由规则在流量上执行一些操作：
- 添加或删除 header
- 重写 URL
- 为调用这一目标地址的请求设置重试策略

#### 3、目标规则 Destination Rule

将虚拟服务视为将流量如何路由到给定目标地址，然后使用目标规则来配置该目标的流量；

1) 负载均衡选项
- 随机：请求以随机的方式转到池中的实例
- 权重：请求根据指定的百分比转到实例
- 最少请求：请求被转到最少被访问的实例

#### 4、网关 Gateway

为网格来管理入站和出站流量，可以让您指定要进入或离开网格的流量

#### 5、服务入口 Service Entry

添加一个入口到 Istio 内部维护的服务注册中心；

配置服务入口允许您管理运行在网格外的服务的流量：
- 为外部目标 redirect 和转发请求，例如来自 web 端的 API 调用，或者流向遗留老系统的服务
- 为外部目标定义重试、超时和故障注入策略
- 添加一个运行在虚拟机的服务来扩展您的网格

#### 6、Sidecar

Istio 让每个 Envoy 代理都可以访问来自和它关联的工作负载的所有端口的请求，然后转发到对应的工作负载；

- 微调 Envoy 代理接受的端口和协议集
- 限制 Envoy 代理可以访问的服务集合

#### 7、网络弹性和测试

Istio 还提供了可选的故障恢复和故障注入功能；

1) 超时
- Istio 允许您使用虚拟服务按服务轻松地动态调整超时，而不必修改您的业务代码 
```shell
timeout: 10s
```

2) 重试
- Envoy 代理尝试连接服务的最大次数
```shell
retries:
  attempts: 3
  perTryTimeout: 2s
```

3) 熔断器
- Istio 为创建具有弹性的微服务应用提供的另一个有用的机制
```shell
trafficPolicy:
  connectionPool:
    tcp:
      maxConnections: 100
```

4) 故障注入
- Istio 的故障注入机制来为整个应用程序测试故障恢复能力

- 延迟：延迟是时间故障。它们模拟增加的网络延迟或一个超载的上游服务
- 终止：终止是崩溃失败。他们模仿上游服务的失败。终止通常以 HTTP 错误码或 TCP 连接失败的形式出现

```shell
- fault:
    delay:
      percentage:
        value: 0.1
      fixedDelay: 5s
```

